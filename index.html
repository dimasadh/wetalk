<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeTalk - Chat Application</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .hidden { display: none !important; }

        /* Auth Section */
        .auth-section { padding: 40px; }
        .auth-header { text-align: center; margin-bottom: 30px; }
        .auth-header h1 { color: #667eea; font-size: 32px; margin-bottom: 10px; }
        .auth-tabs { display: flex; border-bottom: 2px solid #e0e0e0; margin-bottom: 30px; }
        .auth-tab {
            flex: 1; padding: 15px; text-align: center; cursor: pointer;
            font-weight: 600; color: #999; border-bottom: 3px solid transparent;
            margin-bottom: -2px; transition: all 0.3s;
        }
        .auth-tab.active { color: #667eea; border-bottom-color: #667eea; }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
        .form-group input {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0;
            border-radius: 5px; font-size: 14px;
        }
        .form-group input:focus { outline: none; border-color: #667eea; }
        .btn {
            width: 100%; padding: 12px; border: none; border-radius: 5px;
            font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .error-message, .success-message {
            padding: 10px; border-radius: 5px; margin-bottom: 15px; display: none;
        }
        .error-message { background: #fee; color: #c33; }
        .success-message { background: #efe; color: #3c3; }
        .error-message.show, .success-message.show { display: block; }

        /* Chat Section */
        .chat-section { display: none; }
        .chat-section.active { display: flex; height: 80vh; }
        .sidebar {
            width: 300px; background: #f8f9fa; border-right: 1px solid #dee2e6;
            display: flex; flex-direction: column;
        }
        .sidebar-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 20px;
        }
        .sidebar-header h2 { font-size: 18px; margin-bottom: 5px; }
        .sidebar-header p { font-size: 12px; opacity: 0.9; }
        .sidebar-actions { padding: 15px; border-bottom: 1px solid #dee2e6; }
        .btn-small {
            padding: 8px 12px; border: none; border-radius: 5px; font-size: 13px;
            font-weight: 600; cursor: pointer; background: #667eea; color: white;
            margin-right: 5px; transition: all 0.3s;
        }
        .btn-small:hover { background: #5568d3; }
        .btn-logout {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
            color: white; padding: 6px 12px; border-radius: 5px; cursor: pointer;
            font-size: 12px; float: right;
        }
        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item {
            padding: 15px; border-bottom: 1px solid #dee2e6; cursor: pointer;
            transition: background 0.2s;
        }
        .chat-item:hover { background: #e9ecef; }
        .chat-item.active { background: #e7f1ff; }
        .chat-item-name { font-weight: 600; margin-bottom: 5px; }
        .chat-item-type { font-size: 11px; color: #6c757d; }

        .main-chat { flex: 1; display: flex; flex-direction: column; }
        .chat-header {
            background: #fff; padding: 15px 20px; border-bottom: 1px solid #dee2e6;
            display: flex; justify-content: space-between; align-items: center;
        }
        .chat-header h3 { font-size: 18px; color: #333; }
        .chat-status { font-size: 12px; color: #6c757d; padding: 10px 20px; background: #f8f9fa; }
        .chat-status.connected { background: #d4edda; color: #155724; }
        #messages {
            flex: 1; overflow-y: auto; padding: 20px; background: #fff;
        }
        .message {
            margin-bottom: 15px; padding: 10px 15px; border-radius: 8px;
            max-width: 70%; animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message.me {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; margin-left: auto;
        }
        .message.other { background: #f1f3f5; color: #333; }
        .message-sender { font-weight: 600; font-size: 12px; margin-bottom: 5px; opacity: 0.8; }
        .message-text { font-size: 14px; line-height: 1.4; }
        .message-time { font-size: 11px; opacity: 0.7; margin-top: 5px; }
        .chat-input {
            padding: 15px 20px; background: #f8f9fa; border-top: 1px solid #dee2e6;
            display: flex; gap: 10px;
        }
        .chat-input input {
            flex: 1; padding: 10px 15px; border: 2px solid #dee2e6;
            border-radius: 20px; font-size: 14px;
        }
        .chat-input input:focus { outline: none; border-color: #667eea; }
        .btn-send {
            padding: 10px 20px; border: none; border-radius: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; font-weight: 600; cursor: pointer;
        }
        .btn-send:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: white; border-radius: 10px; padding: 30px;
            max-width: 500px; width: 90%;
        }
        .modal-header { margin-bottom: 20px; }
        .modal-header h3 { font-size: 20px; color: #333; }
        .modal-close {
            float: right; font-size: 24px; cursor: pointer; color: #999;
            line-height: 20px; margin-top: -5px;
        }
        .empty-state {
            text-align: center; padding: 40px; color: #6c757d;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Auth Section -->
    <div class="auth-section" id="authSection">
        <div class="auth-header">
            <h1>ðŸ’¬ WeTalk</h1>
            <p>Connect with friends and chat in real-time</p>
        </div>
        <div class="auth-tabs">
            <div class="auth-tab active" onclick="switchAuthTab('login')">Login</div>
            <div class="auth-tab" onclick="switchAuthTab('register')">Register</div>
        </div>
        <div id="authError" class="error-message"></div>
        <div id="authSuccess" class="success-message"></div>
        <form class="auth-form active" id="loginForm" onsubmit="handleLogin(event)">
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" placeholder="Enter your email" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="Enter your password" required>
            </div>
            <button type="submit" class="btn btn-primary" id="btnLogin">Login</button>
        </form>
        <form class="auth-form" id="registerForm" onsubmit="handleRegister(event)">
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="registerUsername" placeholder="Choose a username" required minlength="3">
            </div>
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="registerName" placeholder="Enter your full name" required>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="registerEmail" placeholder="Enter your email" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="registerPassword" placeholder="Choose a password (min 6 chars)" required minlength="6">
            </div>
            <button type="submit" class="btn btn-primary" id="btnRegister">Register</button>
        </form>
    </div>

    <!-- Chat Section -->
    <div class="chat-section" id="chatSection">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2 id="userNameDisplay">Welcome!</h2>
                <p id="userEmailDisplay"></p>
                <button class="btn-logout" onclick="handleLogout()">Logout</button>
            </div>
            <div class="sidebar-actions">
                <button class="btn-small" onclick="showCreatePersonalChatModal()">+ Personal</button>
                <button class="btn-small" onclick="showCreateGroupChatModal()">+ Group</button>
            </div>
            <div class="chat-list" id="chatList">
                <div class="empty-state">No chats yet</div>
            </div>
        </div>
        <div class="main-chat">
            <div class="chat-header">
                <h3 id="currentChatName">Select a chat</h3>
            </div>
            <div id="connectionStatus" class="chat-status">Disconnected</div>
            <div id="messages"></div>
            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="Type your message..." disabled>
                <button id="btnSend" onclick="sendMessage()" class="btn-send" disabled>Send</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Personal Chat Modal -->
<div class="modal" id="personalChatModal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-close" onclick="closeModal('personalChatModal')">&times;</span>
            <h3>Create Personal Chat</h3>
        </div>
        <div class="form-group">
            <label>Participant User ID</label>
            <input type="text" id="personalChatUserId" placeholder="Enter user ID">
        </div>
        <button class="btn btn-primary" onclick="createPersonalChat()">Create Chat</button>
    </div>
</div>

<!-- Create Group Chat Modal -->
<div class="modal" id="groupChatModal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-close" onclick="closeModal('groupChatModal')">&times;</span>
            <h3>Create Group Chat</h3>
        </div>
        <div class="form-group">
            <label>Group Name</label>
            <input type="text" id="groupChatName" placeholder="Enter group name">
        </div>
        <div class="form-group">
            <label>Description</label>
            <input type="text" id="groupChatDesc" placeholder="Optional description">
        </div>
        <div class="form-group">
            <label>User IDs (comma separated)</label>
            <input type="text" id="groupChatUserIds" placeholder="user-1, user-2, user-3">
        </div>
        <button class="btn btn-primary" onclick="createGroupChat()">Create Group</button>
    </div>
</div>

<script>
    const API_URL = 'http://localhost:8080';
    let accessToken = localStorage.getItem('accessToken');
    let currentUser = null;
    let ws = null;
    let currentChatId = null;
    let chats = [];
    let userCache = {};
    let refreshTimer = null;

    // Initialize
    function init() {
        const userStr = localStorage.getItem('currentUser');
        if (accessToken && userStr) {
            currentUser = JSON.parse(userStr);
            showChatSection();
            startAutoRefresh();
            loadChats();
        }
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.target.disabled) sendMessage();
        });
    }

    // Auth functions
    function switchAuthTab(tab) {
        document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
        if (tab === 'login') {
            document.querySelectorAll('.auth-tab')[0].classList.add('active');
            document.getElementById('loginForm').classList.add('active');
        } else {
            document.querySelectorAll('.auth-tab')[1].classList.add('active');
            document.getElementById('registerForm').classList.add('active');
        }
        hideAuthMessages();
    }

    function showAuthError(msg) {
        const el = document.getElementById('authError');
        el.textContent = msg;
        el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 5000);
    }

    function showAuthSuccess(msg) {
        const el = document.getElementById('authSuccess');
        el.textContent = msg;
        el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 3000);
    }

    function hideAuthMessages() {
        document.getElementById('authError').classList.remove('show');
        document.getElementById('authSuccess').classList.remove('show');
    }

    async function handleRegister(e) {
        e.preventDefault();
        hideAuthMessages();
        const btn = document.getElementById('btnRegister');
        btn.disabled = true;
        btn.textContent = 'Registering...';
        try {
            const res = await fetch(`${API_URL}/auth/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    username: document.getElementById('registerUsername').value,
                    email: document.getElementById('registerEmail').value,
                    password: document.getElementById('registerPassword').value,
                    name: document.getElementById('registerName').value
                })
            });
            const data = await res.json();
            if (res.ok) {
                accessToken = data.data.accessToken;
                currentUser = data.data.user;
                localStorage.setItem('accessToken', accessToken);
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showAuthSuccess('Registration successful!');
                setTimeout(() => { showChatSection(); startAutoRefresh(); loadChats(); }, 1500);
            } else {
                showAuthError(data.message || 'Registration failed');
            }
        } catch (err) {
            showAuthError('Network error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Register';
        }
    }

    async function handleLogin(e) {
        e.preventDefault();
        hideAuthMessages();
        const btn = document.getElementById('btnLogin');
        btn.disabled = true;
        btn.textContent = 'Logging in...';
        try {
            const res = await fetch(`${API_URL}/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    email: document.getElementById('loginEmail').value,
                    password: document.getElementById('loginPassword').value
                })
            });
            const data = await res.json();
            if (res.ok) {
                accessToken = data.data.accessToken;
                currentUser = data.data.user;
                localStorage.setItem('accessToken', accessToken);
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showAuthSuccess('Login successful!');
                setTimeout(() => { showChatSection(); startAutoRefresh(); loadChats(); }, 1500);
            } else {
                showAuthError(data.message || 'Login failed');
            }
        } catch (err) {
            showAuthError('Network error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Login';
        }
    }

    async function handleLogout() {
        try {
            await fetch(`${API_URL}/auth/logout`, { method: 'POST', credentials: 'include' });
        } catch (err) {}
        if (ws) ws.close();
        stopAutoRefresh();
        accessToken = null;
        currentUser = null;
        localStorage.clear();
        showAuthSection();
    }

    function showAuthSection() {
        document.getElementById('authSection').classList.remove('hidden');
        document.getElementById('chatSection').classList.remove('active');
    }

    function showChatSection() {
        document.getElementById('authSection').classList.add('hidden');
        document.getElementById('chatSection').classList.add('active');
        document.getElementById('userNameDisplay').textContent = currentUser.name;
        document.getElementById('userEmailDisplay').textContent = currentUser.email;
    }

    function startAutoRefresh() {
        refreshTimer = setInterval(async () => {
            try {
                const res = await fetch(`${API_URL}/auth/refresh`, { method: 'POST', credentials: 'include' });
                if (res.ok) {
                    const data = await res.json();
                    accessToken = data.data.accessToken;
                    localStorage.setItem('accessToken', accessToken);
                }
            } catch (err) {
                handleLogout();
            }
        }, 14 * 60 * 1000);
    }

    function stopAutoRefresh() {
        if (refreshTimer) clearInterval(refreshTimer);
    }

    async function authFetch(url, options = {}) {
        options.headers = options.headers || {};
        options.headers['Authorization'] = `Bearer ${accessToken}`;
        let res = await fetch(url, options);
        if (res.status === 401) {
            const refreshRes = await fetch(`${API_URL}/auth/refresh`, { method: 'POST', credentials: 'include' });
            if (refreshRes.ok) {
                const data = await refreshRes.json();
                accessToken = data.data.accessToken;
                localStorage.setItem('accessToken', accessToken);
                options.headers['Authorization'] = `Bearer ${accessToken}`;
                res = await fetch(url, options);
            } else {
                handleLogout();
                throw new Error('Session expired');
            }
        }
        return res;
    }

    // Chat functions
    async function loadChats() {
        try {
            const res = await authFetch(`${API_URL}/user/chats`);
            const data = await res.json();
            if (res.ok && data.data) {
                chats = data.data;
                renderChatList();
            }
        } catch (err) {
            console.error('Load chats error:', err);
        }
    }

    function renderChatList() {
        const list = document.getElementById('chatList');
        if (!chats || chats.length === 0) {
            list.innerHTML = '<div class="empty-state">No chats yet</div>';
            return;
        }
        list.innerHTML = chats.map(chat => `
            <div class="chat-item ${currentChatId === chat.id ? 'active' : ''}" onclick="selectChat('${chat.id}')">
                <div class="chat-item-name">${chat.name}</div>
                <div class="chat-item-type">${chat.type}</div>
            </div>
        `).join('');
    }

    async function selectChat(chatId) {
        currentChatId = chatId;
        const chat = chats.find(c => c.id === chatId);
        if (chat) {
            console.log(chat)
            document.getElementById('currentChatName').textContent = chat.name;
            renderChatList();
            await loadMessages();
            connectWebSocket();
        }
    }

    async function loadMessages() {
        try {
            const res = await authFetch(`${API_URL}/chat/${currentChatId}/messages`);
            const data = await res.json();
            if (res.ok && data.data) {
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = '';
                for (const msg of data.data.sort((a,b) => a.timestamp - b.timestamp)) {
                    await displayMessage(msg);
                }
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        } catch (err) {
            console.error('Load messages error:', err);
        }
    }

    async function displayMessage(msg) {
        const div = document.createElement('div');
        div.className = `message ${msg.senderId === currentUser.id ? 'me' : 'other'}`;
        const time = new Date(msg.timestamp).toLocaleTimeString();
        if (msg.senderId === currentUser.id) {
            div.innerHTML = `<div class="message-text">${escapeHtml(msg.message)}</div><div class="message-time">${time}</div>`;
        } else {
            const name = await getUserName(msg.senderId);
            div.innerHTML = `<div class="message-sender">${escapeHtml(name)}</div><div class="message-text">${escapeHtml(msg.message)}</div><div class="message-time">${time}</div>`;
        }
        document.getElementById('messages').appendChild(div);
    }

    async function getUserName(userId) {
        if (userCache[userId]) return userCache[userId];
        try {
            const res = await authFetch(`${API_URL}/user/${userId}`);
            const data = await res.json();
            if (res.ok && data.data) {
                userCache[userId] = data.data.name;
                return data.data.name;
            }
        } catch (err) {}
        return userId;
    }

    function connectWebSocket() {
        if (ws) ws.close();
        ws = new WebSocket(`ws://localhost:8080/ws/${currentUser.id}`);
        ws.onopen = () => {
            updateStatus(true);
            document.getElementById('messageInput').disabled = false;
            document.getElementById('btnSend').disabled = false;
        };
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            const div = document.createElement('div');
            div.className = 'message other';
            const time = new Date(data.timestamp).toLocaleTimeString();
            div.innerHTML = `<div class="message-sender">${escapeHtml(data.userName)}</div><div class="message-text">${escapeHtml(data.message)}</div><div class="message-time">${time}</div>`;
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
            ws.send(JSON.stringify({ messageId: data.messageId, chatId: currentChatId }));
        };
        ws.onclose = () => updateStatus(false);
        ws.onerror = () => updateStatus(false);
    }

    function updateStatus(connected) {
        const el = document.getElementById('connectionStatus');
        el.textContent = connected ? 'Connected' : 'Disconnected';
        el.className = `chat-status ${connected ? 'connected' : ''}`;
    }

    function sendMessage() {
        const input = document.getElementById('messageInput');
        if (!input.value.trim() || !currentChatId) return;
        const payload = { timestamp: Date.now(), chatId: currentChatId, message: input.value };
        ws.send(JSON.stringify(payload));
        const div = document.createElement('div');
        div.className = 'message me';
        const time = new Date(payload.timestamp).toLocaleTimeString();
        div.innerHTML = `<div class="message-text">${escapeHtml(input.value)}</div><div class="message-time">${time}</div>`;
        document.getElementById('messages').appendChild(div);
        document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        input.value = '';
    }

    // Modal functions
    function showCreatePersonalChatModal() {
        document.getElementById('personalChatModal').classList.add('show');
    }

    function showCreateGroupChatModal() {
        document.getElementById('groupChatModal').classList.add('show');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('show');
    }

    async function createPersonalChat() {
        const userId = document.getElementById('personalChatUserId').value.trim();
        if (!userId) return alert('User ID required');
        try {
            const res = await authFetch(`${API_URL}/chat/personal`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ participantId: userId })
            });
            const data = await res.json();
            if (res.ok) {
                closeModal('personalChatModal');
                document.getElementById('personalChatUserId').value = '';
                await loadChats();
                selectChat(data.data.chatId);
            } else {
                alert(data.message || 'Failed to create chat');
            }
        } catch (err) {
            alert('Error creating chat');
        }
    }

    async function createGroupChat() {
        const name = document.getElementById('groupChatName').value.trim();
        const desc = document.getElementById('groupChatDesc').value.trim();
        const userIdsStr = document.getElementById('groupChatUserIds').value.trim();
        if (!name || !userIdsStr) return alert('Name and user IDs required');
        const userIds = userIdsStr.split(',').map(id => id.trim()).filter(id => id);
        try {
            const res = await authFetch(`${API_URL}/chat/group`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, description: desc, userIds })
            });
            const data = await res.json();
            if (res.ok) {
                closeModal('groupChatModal');
                document.getElementById('groupChatName').value = '';
                document.getElementById('groupChatDesc').value = '';
                document.getElementById('groupChatUserIds').value = '';
                await loadChats();
                selectChat(data.data.chatId);
            } else {
                alert(data.message || 'Failed to create group');
            }
        } catch (err) {
            alert('Error creating group');
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    window.onload = init;
</script>
</body>
</html>
