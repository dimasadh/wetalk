<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Client</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #messages {
            border: 1px solid #ccc;
            height: 400px;
            overflow-y: auto;
            padding: 10px;
            margin: 20px 0;
            background-color: #f9f9f9;
        }
        .message {
            margin: 5px 0;
            padding: 5px;
        }
        .message.me {
            color: #0066cc;
            font-weight: bold;
        }
        .message.other {
            color: #333;
        }
        .message.unread {
            background-color: #ffffcc;
        }
        input[type="text"] {
            width: 300px;
            padding: 8px;
            margin: 5px;
        }
        button {
            padding: 8px 15px;
            margin: 5px;
            cursor: pointer;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
<h1>WebSocket Client</h1>
<div>
    <input type="text" id="chatIdInput" placeholder="Enter chat ID">
</div>
<div>
    <input type="text" id="userIdInput" placeholder="Enter your user ID (UUID)">
    <button onclick="connect()">Connect</button>
    <button onclick="loadHistory()" id="btnLoadHistory" disabled>Load History</button>
</div>
<div>
    <input type="text" id="messageInput" placeholder="Enter your message">
    <button id="btnMessage" onclick="sendMessage()" disabled>Send</button>
</div>
<div id="messages"></div>

<script>
    let ws;
    let currentUserId;
    let currentChatId;
    let userCache = {};

    async function loadHistory() {
        const chatId = document.getElementById("chatIdInput").value;
        if (!chatId) {
            alert("Please enter a chat ID");
            return;
        }

        try {
            const response = await fetch(`http://localhost:8080/chat/${chatId}/messages`);
            const result = await response.json();
            
            if (result.message === "success" && result.data) {
                const messagesDiv = document.getElementById("messages");
                messagesDiv.innerHTML = '<div class="loading">Loading message history...</div>';
                
                // Sort messages by timestamp (oldest first)
                const messages = result.data.sort((a, b) => a.timestamp - b.timestamp);
                
                messagesDiv.innerHTML = '';
                
                for (const msg of messages) {
                    await displayHistoricalMessage(msg);
                }
                
                // Scroll to bottom
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                
                console.log(`Loaded ${messages.length} messages`);
            }
        } catch (error) {
            console.error("Error loading message history:", error);
            alert("Failed to load message history");
        }
    }

    async function displayHistoricalMessage(msg) {
        const messageDisplay = document.getElementById("messages");
        const messageTime = new Date(msg.timestamp);
        const messageElement = document.createElement("div");
        messageElement.className = "message";
        
        if (msg.senderId === currentUserId) {
            messageElement.classList.add("me");
            messageElement.textContent = `[${messageTime.toLocaleTimeString()}] Me: ${msg.message}`;
        } else {
            messageElement.classList.add("other");
            
            // Get sender name
            const senderName = await getUserName(msg.senderId);
            messageElement.textContent = `[${messageTime.toLocaleTimeString()}] ${senderName}: ${msg.message}`;
            
            // Mark as unread if not read yet
            if (!msg.isRead) {
                messageElement.classList.add("unread");
            }
        }
        
        messageElement.dataset.messageId = msg.id;
        messageDisplay.appendChild(messageElement);
    }

    async function getUserName(userId) {
        // Check cache first
        if (userCache[userId]) {
            return userCache[userId];
        }
        
        try {
            const response = await fetch(`http://localhost:8080/user/${userId}`);
            const result = await response.json();
            
            if (result.message === "success" && result.data) {
                userCache[userId] = result.data.name;
                return result.data.name;
            }
        } catch (error) {
            console.error("Error fetching user:", error);
        }
        
        // Fallback to userId if name not found
        return userId;
    }

    async function connect() {
        const userId = document.getElementById("userIdInput").value;
        const chatId = document.getElementById("chatIdInput").value;
        
        if (!userId) {
            alert("Please enter a user ID");
            return;
        }
        
        if (!chatId) {
            alert("Please enter a chat ID");
            return;
        }

        currentUserId = userId;
        currentChatId = chatId;

        // Load message history first
        await loadHistory();

        ws = new WebSocket("ws://localhost:8080/ws/" + userId);

        ws.onopen = function() {
            console.log("Connected to WebSocket server");
            document.getElementById("btnMessage").disabled = false;
            document.getElementById("btnLoadHistory").disabled = false;
        };

        ws.onmessage = function(event) {
            let messageDisplay = document.getElementById("messages");

            // message = {"messageId": "...", "userId": "...", "userName": "...", "message": "...", "timestamp": ..., "isRead": false}
            let data = JSON.parse(event.data);
            let messageTime = new Date(data.timestamp);
            let messageElement = document.createElement("div");
            messageElement.className = "message other";
            messageElement.textContent = `[${messageTime.toLocaleTimeString()}] ${data.userName}: ${data.message}`;
            messageElement.dataset.messageId = data.messageId;
            
            // Mark as unread initially
            if (!data.isRead) {
                messageElement.classList.add("unread");
            }
            
            messageDisplay.appendChild(messageElement);
            
            // Scroll to bottom
            messageDisplay.scrollTop = messageDisplay.scrollHeight;
            
            // Send read acknowledgment
            sendReadAcknowledgment(data.messageId, currentChatId);
            
            // Remove unread styling after acknowledging
            setTimeout(() => {
                messageElement.classList.remove("unread");
            }, 500);
        };

        ws.onclose = function() {
            console.log("WebSocket connection closed");
            document.getElementById("btnMessage").disabled = true;
        };

        ws.onerror = function(error) {
            console.error("WebSocket error:", error);
            document.getElementById("btnMessage").disabled = true;
        };
    }

    function sendMessage() {
        let input = document.getElementById("messageInput");
        let chatId = document.getElementById("chatIdInput").value;
        if (!chatId) {
            alert("Please enter a chat ID");
            return;
        }

        if (!input.value.trim()) {
            alert("Please enter a message");
            return;
        }

        let payload = {
            "timestamp": Date.now(),
            "chatId": chatId,
            "message": input.value,
        };
        
        let messageText = input.value;
        input.value = "";

        ws.send(JSON.stringify(payload));

        let messageDisplay = document.getElementById("messages");
        let messageElement = document.createElement("div");
        messageElement.className = "message me";
        let messageTime = new Date(payload.timestamp);
        messageElement.textContent = `[${messageTime.toLocaleTimeString()}] Me: ${messageText}`;
        messageDisplay.appendChild(messageElement);
        
        // Scroll to bottom
        messageDisplay.scrollTop = messageDisplay.scrollHeight;
    }

    function sendReadAcknowledgment(messageId, chatId) {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            console.log("WebSocket not connected, cannot send read acknowledgment");
            return;
        }
        
        let ackPayload = {
            "messageId": messageId,
            "chatId": chatId
        };
        
        ws.send(JSON.stringify(ackPayload));
        console.log(`Sent read acknowledgment for message ${messageId}`);
    }

    // Allow sending message with Enter key
    document.addEventListener('DOMContentLoaded', function() {
        const messageInput = document.getElementById("messageInput");
        if (messageInput) {
            messageInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter' && !document.getElementById("btnMessage").disabled) {
                    sendMessage();
                }
            });
        }
    });
</script>
</body>
</html>